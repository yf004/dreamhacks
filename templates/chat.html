<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Bungee&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel="stylesheet">
    <title>chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
</head>
<body>
    <div class="page-container">
        <div class="navbar-column">
            <div class="logo-container">
                <div class="logo">BLOOPI</div>
            </div>
            <div class="nav-container">
                <div id='nav-home' class="nav-item">Home</div>
                <div id='nav-journal' class="nav-item">Journal</div>
                <div id='nav-chat' class="nav-item">Chatbot</div>
            </div>
            <div id="logout">Logout</div>
        </div>
        
        <div class="main-content">
            <div class="main-container">
                <div class="chat-rectangle">
                    <div class="messages-area" id="messagesArea">
                        <!-- Messages will appear here -->
                    </div>
                    
                    <div class="input-container">
                        <textarea
                            class="input-box"
                            id="messageInput"
                            placeholder="Ask me anything"
                            rows="1"
                        ></textarea>
                        <button class="send-button" id="sendButton">
                            <div class="send-icon">
                                <img src="../static/images/send.png" alt="Send">
                            </div>
                        </button>
                    </div>
                </div>
                            </div>
        </div>
    </div>
    <script>
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messagesArea = document.getElementById('messagesArea');

        messageInput.style.height = '3.75rem'; 

        messageInput.addEventListener('input', function() {
        this.style.height = '3.75rem'; 
        if (this.scrollHeight > this.clientHeight) {
            const newHeight = Math.min(this.scrollHeight, 120);
            this.style.height = newHeight + 'px';
        }
        });

        // Send message function
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // Create user message bubble
                const userMessageBubble = document.createElement('div');
                userMessageBubble.className = 'message-bubble user-message';
                userMessageBubble.textContent = message;
            
                // Add to messages area
                messagesArea.appendChild(userMessageBubble);
            
                // Clear input and reset height
                messageInput.value = '';
                messageInput.style.height = '3.75rem';
            
                // Add AI response (after a small delay to simulate thinking)
                setTimeout(() => {
                // Create AI message bubble
                const aiMessageBubble = document.createElement('div');
                aiMessageBubble.className = 'message-bubble ai-message';

                get_ai_response(message, "talk")
                aiMessageBubble.textContent = message;
            
                // Add to messages area
                messagesArea.appendChild(aiMessageBubble);
            
                // Scroll messages to bottom
                messagesArea.scrollTop = messagesArea.scrollHeight;
                }, 500);
                
                // Scroll messages to bottom after user message
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        }

        // Send button click
        sendButton.addEventListener('click', sendMessage);

        // Enter key to send (Shift+Enter for new line)
        messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        });

        // Back button functionality
        document.querySelector('.back-button').addEventListener('click', function() {
        // You can add navigation logic here
        console.log('Back button clicked');
        });

        function setUpNavBar(curr){
            document.getElementById('nav-home').onclick = function(){
                if (curr!== 'home'){window.location.href = "/home";}
            };
            document.getElementById('nav-journal').onclick = function(){
                if (curr!== 'journal'){window.location.href = "/journal";}
            };
            document.getElementById('nav-chat').onclick = function(){
                if (curr!== 'chat'){window.location.href = "/chat";}
            };
        }

        document.addEventListener("DOMContentLoaded", (event) => {
            setUpNavBar('chat')
            document.getElementById('logout').onclick = async function(){
                window.location.href = "/logout";
            }
        });


        async function get_ai_response(user_input, mode){
            let formData = new FormData();
            formData.append('message', user_input);
            formData.append('mode', mode);
            fetch('/get_chatbot_response', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            }).then(data => {
                if (data.hasOwnProperty('response')) {
                    return data.response;
                }
            })
            .catch(error => {
                console.log(error);
            });
        }
    </script>
</body>
</html>